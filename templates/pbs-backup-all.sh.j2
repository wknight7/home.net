#!/bin/bash
# PBS Master Backup Script - All TrueNAS Backups
# Generated by Ansible

set -e

LOG_FILE="/var/log/pbs-backup-all.log"
exec > >(tee -a "${LOG_FILE}") 2>&1

echo "=== Starting All PBS Backups at $(date) ==="

FAILED_BACKUPS=0

{% for item in backup_paths %}
echo "Running backup: {{ item.backup_id }}"
if ! /usr/local/bin/pbs-backup/backup-{{ item.backup_id }}.sh; then
    echo "ERROR: Backup {{ item.backup_id }} failed"
    FAILED_BACKUPS=$((FAILED_BACKUPS + 1))
fi
{% endfor %}

echo "=== All backups completed at $(date) ==="
echo "Failed backups: ${FAILED_BACKUPS}"

if [ ${FAILED_BACKUPS} -gt 0 ]; then
    echo "WARNING: ${FAILED_BACKUPS} backup(s) failed"
    exit 1
else
    echo "SUCCESS: All backups completed successfully"
fi
